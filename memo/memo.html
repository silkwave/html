<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memo App Full</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        background: #2c2c2c;
        color: #fff;
      }
      .container {
        display: flex;
        width: 100%;
        height: 100%;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: #1c1c1c;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #383838;
      }
      .sidebar-header {
        padding: 12px;
      }
      #add-memo-btn,
      .io-btn {
        width: 100%;
        padding: 10px;
        margin: 4px 0;
        background: #0a84ff;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #add-memo-btn:hover,
      .io-btn:hover {
        background: #0059c8;
      }
      #memo-list {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
      }
      .memo-item-container {
        border-bottom: 1px solid #383838;
      }
      .memo-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .memo-item.selected {
        background: #2e3b4a;
      }
      .memo-title-text {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .memo-actions button {
        margin-left: 4px;
        background: none;
        border: none;
        cursor: pointer;
        color: #a0a0a5;
      }
      .memo-actions button:hover {
        color: #fff;
      }

      /* Main */
      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 12px;
      }
      .editor-container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      #memo-title {
        font-size: 20px;
        padding: 12px;
        margin-bottom: 12px;
        border: none;
        border-radius: 6px;
        background: #3a3a3a;
        color: #fff;
      }
      #memo-content {
        flex-grow: 1;
        width: 100%;
        padding: 12px;
        font-size: 16px;
        line-height: 1.5;
        border: none;
        border-radius: 6px;
        background: #3a3a3a;
        color: #fff;
        resize: none;
        overflow-y: auto;
      }

      /* Toast */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
      }
      .toast {
        background: #3a3a3a;
        color: #fff;
        padding: 10px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        display: none;
        z-index: 2000;
      }
      .modal-content {
        background: #3a3a3a;
        padding: 24px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }
      .modal-buttons {
        display: flex;
        gap: 12px;
      }
      .modal-buttons button {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
      }
      #modal-confirm-btn {
        background: #ff453a;
        color: #fff;
      }
      #modal-cancel-btn {
        background: #555;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>

    <div class="modal-overlay" id="modal-overlay">
      <div class="modal-content">
        <h3 id="modal-title"></h3>
        <p id="modal-message"></p>
        <div class="modal-buttons">
          <button id="modal-cancel-btn">Ï∑®ÏÜå</button>
          <button id="modal-confirm-btn">ÌôïÏù∏</button>
        </div>
      </div>
    </div>

    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h1>Memo</h1>
          <button id="add-memo-btn">‚ûï ÏÉà Î£®Ìä∏ Î©îÎ™®</button>
          <button id="open-file-btn" class="io-btn">üìÇ Ïó¥Í∏∞</button>
          <button id="save-btn" class="io-btn">üíæ Ï†ÄÏû•</button>
        </div>
        <ul id="memo-list"></ul>
      </aside>
      <main class="main-content" id="main-content">
        <div class="placeholder">
          <span>Î©îÎ™®Î•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉàÎ°ú ÎßåÎìúÏÑ∏Ïöî.</span>
        </div>
      </main>
    </div>

    <script>
      // DOMContentLoaded Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà: Î¨∏ÏÑú Î°úÎìú ÏôÑÎ£å ÌõÑ Ïã§Ìñâ
      document.addEventListener("DOMContentLoaded", () => {
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÌÇ§, ÎîîÎ∞îÏö¥Ïä§ ÏßÄÏó∞ ÏãúÍ∞Ñ ÏÑ§Ï†ï
                const STORAGE_KEY = "vanilla-memos",
                  DEBOUNCE_DELAY = 500;
                // Î©îÎ™® Îç∞Ïù¥ÌÑ∞, ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î©îÎ™® ID, ÌååÏùº Ìï∏Îì§ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
                let memos = [],
                  currentMemoId = null,
                  fileHandle = null;
        
                // DOM ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
                const memoList = document.getElementById("memo-list"),
                  mainContent = document.getElementById("main-content");
        
                // HTML ÏöîÏÜåÎ•º ÏÉùÏÑ±ÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
                const createElement = (tag, className, innerHTML, attrs = {}) => {
                  const el = document.createElement(tag);
                  if (className) el.className = className;
                  if (innerHTML) el.innerHTML = innerHTML;
                  Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
                  return el;
                };
                // IDÎ°ú Î©îÎ™®Î•º Ï∞æÎäî Ïû¨Í∑Ä Ìï®Ïàò
                const findMemoById = (nodes, id) => {
                  for (const n of nodes) {
                    if (n.id === id) return n;
                    if (n.children) {
                      const f = findMemoById(n.children, id);
                      if (f) return f;
                    }
                  }
                  return null;
                };
                // Î©îÎ™® Íµ¨Ï°∞Î•º ÏàúÌöåÌïòÎ©∞ isExpanded ÏÜçÏÑ±ÏùÑ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÌïòÎäî Ìï®Ïàò
                const traverseAndMigrate = (nodes) =>
                  nodes.map((n) => ({
                    ...n,
                    isExpanded: n.isExpanded !== undefined ? n.isExpanded : true,
                    children: n.children ? traverseAndMigrate(n.children) : [],
                  }));
                // IDÎ°ú Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÎäî Ïû¨Í∑Ä Ìï®Ïàò
                const removeMemoById = (nodes, id) => {
                  const i = nodes.findIndex((n) => n.id === id);
                  if (i > -1) {
                    nodes.splice(i, 1);
                    return true;
                  }
                  for (const n of nodes) {
                    if (n.children && removeMemoById(n.children, id)) return true;
                  }
                  return false;
                };
                // Î©îÎ™®Î•º Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                const saveMemos = () =>
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(memos));
                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î©îÎ™®Î•º Î∂àÎü¨Ïò§Í∏∞
                const loadMemos = () => {
                  const d = localStorage.getItem(STORAGE_KEY);
                  memos = d ? traverseAndMigrate(JSON.parse(d)) : [];
                };
                // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
                const showToast = (msg, type = "success") => {
                  const t = createElement("div", "toast", msg);
                  document.getElementById("toast-container").appendChild(t);
                  setTimeout(() => t.remove(), 3000);
                };
                // Î™®Îã¨ Ï∞Ω ÌëúÏãú Î∞è ÏÇ¨Ïö©Ïûê ÏùëÎãµ Ï≤òÎ¶¨
                const showModal = (title, msg) =>
                  new Promise((res) => {
                    const overlay = document.getElementById("modal-overlay");
                    overlay.style.display = "flex";
                    document.getElementById("modal-title").textContent = title;
                    document.getElementById("modal-message").textContent = msg;
                    const c = document.getElementById("modal-confirm-btn"),
                      x = document.getElementById("modal-cancel-btn");
                    const close = (v) => {
                      overlay.style.display = "none";
                      c.replaceWith(c.cloneNode(true));
                      x.replaceWith(x.cloneNode(true));
                      res(v);
                    };
                    c.addEventListener("click", () => close(true), { once: true });
                    x.addEventListener("click", () => close(false), { once: true });
                  });
                // Î¨∏ÏûêÏó¥ÏùÑ Base64Î°ú Ïù∏ÏΩîÎî©
                const encodeBase64 = (s) => btoa(unescape(encodeURIComponent(s)));
                // Base64 Î¨∏ÏûêÏó¥ÏùÑ ÎîîÏΩîÎî©
                const decodeBase64 = (s) => decodeURIComponent(escape(atob(s)));
        
                // Î©îÎ™® Î™©Î°ùÏùÑ Î†åÎçîÎßÅ
                const renderMemoList = () => {
                  memoList.innerHTML = "";
                  if (memos.length === 0) {
                    memoList.appendChild(
                      createElement("li", "memo-item", "Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.")
                    );
                    return;
                  }
                  memos.forEach((m) => renderNode(m, 0, memoList));
                };
        
                // Í∞úÎ≥Ñ Î©îÎ™® ÎÖ∏ÎìúÎ•º Î†åÎçîÎßÅ (Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú ÏûêÏãù Î©îÎ™® Ï≤òÎ¶¨)
                const renderNode = (memo, depth, container) => {
                  const li = createElement("div", "memo-item-container");
                  const item = createElement("div", "memo-item");
                  item.style.paddingLeft = `${16 + depth * 20}px`;
                  if (memo.id === currentMemoId) item.classList.add("selected");
        
                  const titleSpan = createElement(
                    "span",
                    "memo-title-text",
                    memo.title
                  );
                  titleSpan.addEventListener("click", () => {
                    currentMemoId = memo.id;
                    renderMemoList();
                    renderEditor();
                  });
        
                  const actions = createElement("div", "memo-actions");
                  const addChild = createElement("button", null, "‚ûï");
                  addChild.title = "ÏûêÏãù Ï∂îÍ∞Ä";
                  addChild.addEventListener("click", (e) => {
                    e.stopPropagation();
                    addChildMemo(memo.id);
                  });
                  const del = createElement("button", null, "‚ùå");
                  del.title = "ÏÇ≠Ï†ú";
                  del.addEventListener("click", (e) => {
                    e.stopPropagation();
                    deleteMemo(memo.id);
                  });
                  actions.append(addChild, del);
        
                  const toggle = createElement(
                    "button",
                    null,
                    memo.isExpanded ? "‚ñº" : "‚ñ∂"
                  );
                  toggle.title = "Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞";
                  toggle.style.marginRight = "4px";
                  toggle.addEventListener("click", (e) => {
                    e.stopPropagation();
                    memo.isExpanded = !memo.isExpanded;
                    saveMemos();
                    renderMemoList();
                  });
                  toggle.style.visibility =
                    memo.children.length > 0 ? "visible" : "hidden";
        
                  item.append(toggle, titleSpan, actions);
                  li.appendChild(item);
                  container.appendChild(li);
        
                  if (memo.isExpanded && memo.children.length > 0)
                    memo.children.forEach((c) => renderNode(c, depth + 1, container));
                };
        
                // Î©îÎ™® Ìé∏ÏßëÍ∏∞Î•º Î†åÎçîÎßÅ
                const renderEditor = () => {
                  const memo = findMemoById(memos, currentMemoId);
                  mainContent.innerHTML = "";
                  if (!memo) {
                    mainContent.innerHTML =
                      '<div class="placeholder"><span>Î©îÎ™®Î•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉàÎ°ú ÎßåÎìúÏÑ∏Ïöî.</span></div>';
                    return;
                  }
                  const title = createElement("input", null, null, {
                    id: "memo-title",
                    type: "text",
                    value: memo.title,
                  });
                  const content = createElement("textarea", null, memo.content, {
                    id: "memo-content",
                  });
                  const container = createElement("div", "editor-container");
                  container.append(title, content);
                  mainContent.appendChild(container);
        
                  let debounce;
                  // ÏûêÎèô Ï†ÄÏû• (ÎîîÎ∞îÏö¥Ïä§ Ï†ÅÏö©)
                  const autosave = () => {
                    clearTimeout(debounce);
                    debounce = setTimeout(() => {
                      const m = findMemoById(memos, currentMemoId);
                      if (m) {
                        m.title = title.value;
                        m.content = content.value;
                        saveMemos();
                        renderMemoList();
                      }
                    }, DEBOUNCE_DELAY);
                  };
                  title.addEventListener("input", autosave);
                  content.addEventListener("input", autosave);
                };
        
                // ÏÉà Î£®Ìä∏ Î©îÎ™® Ï∂îÍ∞Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                document
                  .getElementById("add-memo-btn")
                  .addEventListener("click", () => {
                    const m = {
                      id: Date.now().toString(),
                      title: "ÏÉà Î£®Ìä∏ Î©îÎ™®",
                      content: "",
                      children: [],
                      isExpanded: true,
                    };
                    memos.unshift(m);
                    currentMemoId = m.id;
                    saveMemos();
                    renderMemoList();
                    renderEditor();
                    document.getElementById("memo-title").focus();
                    document.getElementById("memo-title").select();
                  });
        
                // ÏûêÏãù Î©îÎ™® Ï∂îÍ∞Ä Ìï®Ïàò
                const addChildMemo = (parentId) => {
                  const parent = findMemoById(memos, parentId);
                  if (!parent) return;
                  const m = {
                    id: Date.now().toString(),
                    title: "ÏÉà ÏûêÏãù Î©îÎ™®",
                    content: "",
                    children: [],
                    isExpanded: true,
                  };
                  parent.children.unshift(m);
                  parent.isExpanded = true;
                  saveMemos();
                  currentMemoId = m.id;
                  renderMemoList();
                  renderEditor();
                  document.getElementById("memo-title").focus();
                  document.getElementById("memo-title").select();
                };
        
                // Î©îÎ™® ÏÇ≠Ï†ú Ìï®Ïàò
                const deleteMemo = async (id) => {
                  if (!id) return;
                  const confirmed = await showModal(
                    "Î©îÎ™® ÏÇ≠Ï†ú",
                    "Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
                  );
                  if (confirmed) {
                    if (removeMemoById(memos, id)) {
                      saveMemos();
                      if (currentMemoId === id) currentMemoId = null;
                      renderMemoList();
                      renderEditor();
                      showToast("ÏÇ≠Ï†ú ÏôÑÎ£å");
                    }
                  }
                };
        
                // ÌååÏùº Ï†ÄÏû• Ìï®Ïàò (File System Access API ÏÇ¨Ïö©)
                const saveFile = async () => {
                  if (memos.length === 0) {
                    showToast("Ï†ÄÏû•Ìï† Î©îÎ™® ÏóÜÏùå", "error");
                    return;
                  }
                  const data = encodeBase64(JSON.stringify(memos));
                  try {
                    // Í∏∞Ï°¥ ÌååÏùº Ìï∏Îì§Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞ ÌôïÏù∏
                    if (fileHandle) {
                      const confirmed = await showModal(
                        "ÌååÏùº Ï†ÄÏû•",
                        `'${fileHandle.name}' ÎçÆÏñ¥Ïì∞Í∏∞?`
                      );
                      if (!confirmed) return;
                      const w = await fileHandle.createWritable();
                      await w.write(data);
                      await w.close();
                    } else {
                      // ÏÉà ÌååÏùºÎ°ú Ï†ÄÏû•
                      const h = await window.showSaveFilePicker({
                        suggestedName: "memos.json",
                      });
                      fileHandle = h;
                      const w = await fileHandle.createWritable();
                      await w.write(data);
                      await w.close();
                    }
                    showToast("ÌååÏùº Ï†ÄÏû• ÏôÑÎ£å");
                  } catch (e) {
                    // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜåÌñàÍ±∞ÎÇò Îã§Î•∏ Ïò§Î•ò Î∞úÏÉù Ïãú
                    if (e.name !== "AbortError") showToast("ÌååÏùº Ï†ÄÏû• Ïã§Ìå®", "error");
                  }
                };
        
                // ÌååÏùº Ïó¥Í∏∞ Ìï®Ïàò (File System Access API ÏÇ¨Ïö©)
                const openFile = async () => {
                  const confirmed = await showModal(
                    "ÌååÏùº Ïó¥Í∏∞",
                    "ÌòÑÏû¨ Î©îÎ™® Î™®Îëê ÍµêÏ≤¥Îê©ÎãàÎã§. Í≥ÑÏÜç?"
                  );
                  if (!confirmed) return;
                  try {
                    const [handle] = await window.showOpenFilePicker({
                      types: [
                        {
                          description: "JSON Files",
                          accept: { "application/json": [".json"] },
                        },
                      ],
                    });
                    fileHandle = handle;
                    const file = await handle.getFile();
                    const content = await file.text();
                    // Base64 ÎîîÏΩîÎî© ÌõÑ Î©îÎ™® Î°úÎìú
                    memos = traverseAndMigrate(JSON.parse(decodeBase64(content)));
                    currentMemoId = memos.length > 0 ? memos[0].id : null;
                    saveMemos();
                    renderMemoList();
                    renderEditor();
                    showToast("Î©îÎ™® Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å");
                  } catch (e) {
                    // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜåÌñàÍ±∞ÎÇò Îã§Î•∏ Ïò§Î•ò Î∞úÏÉù Ïãú
                    if (e.name !== "AbortError") showToast("ÌååÏùº Ïó¥Í∏∞ Ïã§Ìå®", "error");
                  }
                };
        
                // ÌååÏùº Ï†ÄÏû•/Ïó¥Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                document.getElementById("save-btn").addEventListener("click", saveFile);
                document
                  .getElementById("open-file-btn")
                  .addEventListener("click", openFile);
        
                // Ï¥àÍ∏∞ Î°úÎìú Î∞è Î†åÎçîÎßÅ
                loadMemos();
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î©îÎ™®Í∞Ä ÏóÜÍ±∞ÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï≤´ Î≤àÏß∏ Î©îÎ™®Î•º ÏÑ†ÌÉù
                if (memos.length > 0 && !findMemoById(memos, currentMemoId))
                  currentMemoId = memos[0].id;
                renderMemoList();
                renderEditor();
              });    </script>
  </body>
</html>
