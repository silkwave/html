<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AES-128 CBC μ•”νΈν™”/λ³µνΈν™”</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      textarea,
      input {
        width: 100%;
        margin-top: 5px;
        margin-bottom: 15px;
        font-size: 14px;
        padding: 8px;
        box-sizing: border-box;
      }
      textarea {
        min-height: 70px;
        resize: vertical;
      }
      button {
        padding: 10px;
        font-size: 14px;
        margin-right: 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>AES-128 CBC μ•”νΈν™” / λ³µνΈν™”</h2>

    <!-- ν‚¤ μ…λ ¥μ°½: μµλ€ 16λ°”μ΄νΈ, IVλ” ν‚¤μ™€ λ™μΌν•κ² μ‚¬μ© -->
    <label>ν‚¤ (μµλ€ 16λ°”μ΄νΈ, IVλ„ λ™μΌκ°’ μ‚¬μ©)</label>
    <input type="text" id="key" value="1234567890123456" maxlength="32" />

    <!-- μ•”νΈν™”ν•  ν‰λ¬Έ μ…λ ¥μ°½ -->
    <label>ν‰λ¬Έ (μ•”νΈν™”ν•  λ‚΄μ©)</label>
    <textarea id="plainText">μ•λ…•ν•μ„Έμ” AES ν…μ¤νΈμ…λ‹λ‹¤!</textarea>

    <!-- λ³µνΈν™”ν•  Base64 μ•”νΈλ¬Έ μ…λ ¥μ°½ -->
    <label>μ•”νΈλ¬Έ (Base64, λ³µνΈν™”ν•  μ•”νΈλ¬Έ)</label>
    <textarea id="cipherText"></textarea>

    <div>
      <button onclick="encrypt()">π”’ μ•”νΈν™”</button>
      <button onclick="decrypt()">π”“ λ³µνΈν™”</button>
    </div>

    <!-- μ•”νΈν™” λλ” λ³µνΈν™” κ²°κ³Ό μ¶λ ¥ -->
    <label>κ²°κ³Ό</label>
    <textarea id="result" readonly></textarea>

    <script>
      // λ¬Έμμ—΄μ„ Uint8Arrayλ΅ λ³€ν™ (UTF-8 μΈμ½”λ”©)
      function strToBuffer(str) {
        return new TextEncoder().encode(str);
      }

      // Base64 λ¬Έμμ—΄μ„ ArrayBufferλ΅ λ³€ν™
      function base64ToBuffer(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }

      // ArrayBufferλ¥Ό Base64 λ¬Έμμ—΄λ΅ λ³€ν™
      function bufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        bytes.forEach((b) => (binary += String.fromCharCode(b)));
        return btoa(binary);
      }

      // ν‚¤λ¥Ό 16λ°”μ΄νΈλ΅ μλ¥΄κ±°λ‚ κ³µλ°±μΌλ΅ μ±„μ›μ„ μ²λ¦¬ (AES-128)
      function getKeyAndIV(keyStr) {
        const trimmed = keyStr.slice(0, 16); // μµλ€ 16λ°”μ΄νΈ μλ¥΄κΈ°
        const keyBuf = strToBuffer(trimmed.padEnd(16, " ")); // λ¶€μ΅±ν•λ©΄ κ³µλ°±μΌλ΅ μ±„μ›€
        return keyBuf;
      }

      // μ•”νΈν™” ν•¨μ
      async function encrypt() {
        const plainText = document.getElementById("plainText").value;
        const keyStr = document.getElementById("key").value;
        const key = getKeyAndIV(keyStr);
        const iv = key; // IVλ” ν‚¤μ™€ λ™μΌν•κ² μ‚¬μ©
        const data = strToBuffer(plainText);

        try {
          // μ•”νΈν™” ν‚¤ κ°€μ Έμ¤κΈ°
          const cryptoKey = await crypto.subtle.importKey(
            "raw",
            key,
            { name: "AES-CBC" },
            false,
            ["encrypt"]
          );

          // μ•”νΈν™” μ‹¤ν–‰
          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-CBC", iv },
            cryptoKey,
            data
          );

          // Base64 μΈμ½”λ”© ν›„ μ¶λ ¥
          const base64 = bufferToBase64(encrypted);
          document.getElementById("cipherText").value = base64;
          document.getElementById("result").value =
            "π” μ•”νΈν™” μ™„λ£:\n" + base64;
        } catch (e) {
          document.getElementById("result").value =
            "β μ•”νΈν™” μ‹¤ν¨: " + e.message;
        }
      }

      // λ³µνΈν™” ν•¨μ
      async function decrypt() {
        const base64 = document.getElementById("cipherText").value.trim();
        const keyStr = document.getElementById("key").value;
        const key = getKeyAndIV(keyStr);
        const iv = key; // IVλ„ ν‚¤μ™€ λ™μΌ
        const cipherBytes = base64ToBuffer(base64);

        try {
          // λ³µνΈν™” ν‚¤ κ°€μ Έμ¤κΈ°
          const cryptoKey = await crypto.subtle.importKey(
            "raw",
            key,
            { name: "AES-CBC" },
            false,
            ["decrypt"]
          );

          // λ³µνΈν™” μ‹¤ν–‰
          const decrypted = await crypto.subtle.decrypt(
            { name: "AES-CBC", iv },
            cryptoKey,
            cipherBytes
          );

          // UTF-8 λ””μ½”λ”©ν•μ—¬ μ¶λ ¥
          const resultText = new TextDecoder().decode(decrypted);
          document.getElementById("plainText").value = resultText;
          document.getElementById("result").value =
            "β… λ³µνΈν™” μ„±κ³µ:\n" + resultText;
        } catch (e) {
          document.getElementById("result").value =
            "β λ³µνΈν™” μ‹¤ν¨: μ•”νΈλ¬Έ λλ” ν‚¤ ν™•μΈ ν•„μ”";
        }
      }
    </script>
  </body>
</html>
